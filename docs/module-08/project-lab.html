<!DOCTYPE html>
<html>
<head>
	<title>Module 08: Project 8 Lab - SNS & SQS Workflow</title>
    <style>
        @font-face {
            font-family: 'icomoon';
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot');
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot#iefix-8k8p81') format('embedded-opentype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.ttf') format('truetype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.woff') format('woff'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.svg#icomoon') format('svg');
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/reset.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/fonts/fontawesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/highlight/styles/monokai-sublime.min.css">
	<link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/cse450.css?v1.5.2">
    <meta charset="utf-8">

</head>
<body class="index-page">
     <div id="modal-screen">
        <div id="contents-wrapper">
            <div class="toc">
<ul>
<li><a href="#product-objective">Product Objective</a></li>
<li><a href="#create-the-sns-topic">Create the SNS Topic</a></li>
<li><a href="#create-a-sqs-queue">Create a SQS Queue</a></li>
<li><a href="#create-a-second-queue">Create a second Queue</a></li>
<li><a href="#subscribe-to-the-topic-for-both-queues">Subscribe to the topic for both Queues</a></li>
<li><a href="#add-the-filter">Add the filter</a></li>
<li><a href="#send-a-message">Send a message</a></li>
<li><a href="#view-the-message">View the message</a></li>
<li><a href="#send-another-message">Send another message</a></li>
<li><a href="#update-our-lambda-to-send-a-sns-message-on-updates">Update our lambda to send a SNS message on updates.</a></li>
<li><a href="#add-a-lambda-to-run-when-a-message-is-received">Add a lambda to run when a message is received</a></li>
<li><a href="#lab-summary">Lab Summary</a><ul>
<li><a href="#key-concepts-explained">Key Concepts Explained:</a></li>
</ul>
</li>
<li><a href="#key-aws-services">Key AWS Services:</a><ul>
<li><a href="#reflection-questions">Reflection Questions:</a></li>
</ul>
</li>
</ul>
</div>

            <a href="#" id="hide-contents" title="Close Table of Contents"><i class="far fa-window-close"></i></a>
        </div>
    </div>
	<header>
        <span class="icon-byui-logo"></span>
        <div id="titles">
            <h1>ITM 300 - Cloud Foundations</h1>
            <h2>Module 08: Project 8 Lab - SNS & SQS Workflow</h2>
            <nav><a href="https://byui-cse.github.io/itm300-course"><i class="fas fa-home"></i></a><a href="https://byui-cse.github.io/itm300-course/modules/">Modules</a><a href="https://byui-cse.github.io/itm300-course/test-prep/">Test Prep</a></nav>
        </div>
        <a href="#" id="show-contents" title="Show Table of Contents"><i class="far fa-list-alt"></i></a>
    </header>
	<article>
		<p><img alt="Quick Oil Change and Repair" src="https://byui-cse.github.io/itm300-course/shared/img/sns_sqs.jpg" /></p>
<h2 id="product-objective">Product Objective</h2>
<p>In this lab, we will leverage AWS Simple Notification Service (SNS) and Simple Queue Service (SQS) to set up a system capable of sending multiple push messages to various services, such as billing, customer notifications, and analytics. By sending a single SNS message upon a service status update, we can trigger multiple downstream services, streamlining communication and ensuring efficient, real-time updates across our application.</p>
<h2 id="create-the-sns-topic">Create the SNS Topic</h2>
<ul>
<li>Search for SNS which will bring up the Simple Notification Service</li>
<li>Create topic: <strong>VehicleStatus</strong></li>
<li>Standard</li>
<li>Click Create Topic</li>
<li>Leave the rest of the defaults</li>
</ul>
<h2 id="create-a-sqs-queue">Create a SQS Queue</h2>
<ul>
<li>Search for SQS which will bring up the Simple Queue Service</li>
<li>Create queue: <strong>VehicleCompletedQueue</strong></li>
<li>Standard</li>
<li>Leave the rest of the defaults</li>
</ul>
<h2 id="create-a-second-queue">Create a second Queue</h2>
<ul>
<li>Create queue: <strong>AllStatusUpdatesQueue</strong></li>
<li>Standard</li>
<li>Leave the rest of the defaults</li>
</ul>
<h2 id="subscribe-to-the-topic-for-both-queues">Subscribe to the topic for both Queues</h2>
<ul>
<li>Click on the <strong>VehicleCompletedQueue</strong></li>
<li>Click on Subscribe to SNS Topic</li>
<li>Choose <strong>VehicleStatus</strong></li>
<li>Click Save</li>
</ul>
<p>Follow the same steps to subscribe to the VehicleStatus SNS Topic for the AllStatusUpdatesQueue as well.</p>
<h2 id="add-the-filter">Add the filter</h2>
<ul>
<li>Go to the VehicleStatus SNS Dashboard and click on Subscriptions in the left hand panel.</li>
<li>Click on the subscriptions and look for the AllVehicleUpdatesQueue under the endpoint. You may need to look at both to find the correct subscription.</li>
<li>Click Edit</li>
<li>Open the Subscription filter policy</li>
<li>Paste the following into the filter policy</li>
</ul>
<div class="codehilite"><pre><span></span><code>{
  &quot;service_status&quot;: [
    &quot;Completed&quot;
  ]
}
</code></pre></div>

<ul>
<li>Click Save Changes</li>
</ul>
<h2 id="send-a-message">Send a message</h2>
<ul>
<li>Click Topics in the left hand panel of the SNS dashboard</li>
<li>Click on VehicleStatus</li>
<li>Click Publish Message</li>
<li>Subject: TestMessage</li>
<li>Message body: Testing a message</li>
<li>Message attributes:<ul>
<li>Type: String  </li>
<li>Name: service_status</li>
<li>Value: Completed</li>
</ul>
</li>
<li>Click Publish Message</li>
</ul>
<h2 id="view-the-message">View the message</h2>
<ul>
<li>Go to the SQS dashboard</li>
<li>Click on AllStatusUpdatesQueue</li>
<li>Click Send and Receive Messages</li>
<li>Scroll to the bottom and click Poll for messages</li>
<li>The message should appear under messages.</li>
</ul>
<p>Do the same for the <strong>VehicleCompletedQueue</strong>. You should see the message in both places.</p>
<h2 id="send-another-message">Send another message</h2>
<p>Send another message, but this time put <em>Approved</em> for the service_status. Go back and check the queues. You should see the message in the AllStatusUpdatesQueue, but not the VehicleCompletedQueue because of the filter we added to the subscription.</p>
<h2 id="update-our-lambda-to-send-a-sns-message-on-updates">Update our lambda to send a SNS message on updates.</h2>
<ul>
<li>Go to the adminGetServiceRequest Lambda</li>
<li>update the lambda adminDynamoService.mjs file</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="p">{</span> <span class="n">SNSClient</span><span class="p">,</span> <span class="n">PublishCommand</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/client-sns&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">ES</span> <span class="n">Modules</span> <span class="kn">import</span>
<span class="nn">import</span> <span class="p">{</span> <span class="n">DynamoDBClient</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/client-dynamodb&quot;</span><span class="p">;</span>
<span class="kn">import</span> <span class="p">{</span>
  <span class="n">DynamoDBDocumentClient</span><span class="p">,</span>
  <span class="n">ScanCommand</span><span class="p">,</span>
  <span class="n">PutCommand</span><span class="p">,</span>
  <span class="n">GetCommand</span><span class="p">,</span>
  <span class="n">DeleteCommand</span><span class="p">,</span>
  <span class="n">UpdateCommand</span><span class="p">,</span>
<span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/lib-dynamodb&quot;</span><span class="p">;</span>

<span class="n">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DynamoDBClient</span><span class="p">({});</span>

<span class="n">const</span> <span class="n">mydynamodb</span> <span class="o">=</span> <span class="n">DynamoDBDocumentClient</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

<span class="n">const</span> <span class="n">tableName</span> <span class="o">=</span> <span class="s2">&quot;VehicleServices&quot;</span><span class="p">;</span>    

<span class="n">export</span> <span class="n">const</span> <span class="n">getDynamoServiceRequests</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">statusToExclude</span> <span class="o">=</span> <span class="s2">&quot;Completed&quot;</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">statusToExcludeRejected</span> <span class="o">=</span> <span class="s2">&quot;Service Rejected&quot;</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="n">const</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
            <span class="n">FilterExpression</span><span class="p">:</span> <span class="s2">&quot;attribute_not_exists(service_status) OR (#service_status &lt;&gt; :status AND #service_status &lt;&gt; :statusRejected)&quot;</span><span class="p">,</span>
            <span class="n">ExpressionAttributeNames</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;#service_status&quot;</span><span class="p">:</span> <span class="s2">&quot;service_status&quot;</span>
            <span class="p">},</span>
            <span class="n">ExpressionAttributeValues</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;:status&quot;</span><span class="p">:</span> <span class="n">statusToExclude</span><span class="p">,</span>
                <span class="s2">&quot;:statusRejected&quot;</span><span class="p">:</span><span class="n">statusToExcludeRejected</span>
            <span class="p">}</span>
        <span class="p">};</span>      
        <span class="n">const</span> <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">ScanCommand</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">Items</span><span class="p">;</span> <span class="o">//</span> <span class="n">Return</span> <span class="n">JSON</span> <span class="n">string</span> <span class="n">of</span> <span class="n">items</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error fetching DynamoDB service requests:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
        <span class="n">throw</span> <span class="n">error</span><span class="p">;</span> <span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">throw</span> <span class="n">the</span> <span class="n">error</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span> <span class="n">further</span> <span class="n">up</span> <span class="n">the</span> <span class="n">call</span> <span class="n">stack</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">export</span> <span class="n">const</span> <span class="n">addDynamoServiceRequest</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">requestBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">serviceId</span> <span class="o">=</span> <span class="n">generateServiceId</span><span class="p">();</span> <span class="o">//</span> <span class="n">Generate</span> <span class="n">unique</span> <span class="n">service_id</span> <span class="n">based</span> <span class="n">on</span> <span class="n">current</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">time</span>      
    <span class="n">const</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
      <span class="n">Item</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">service_id</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span> <span class="o">//</span> <span class="n">Assuming</span> <span class="n">service_id</span> <span class="ow">is</span> <span class="n">provided</span> <span class="ow">in</span> <span class="n">requestBody</span>
        <span class="n">service_status</span><span class="p">:</span> <span class="s2">&quot;New Request&quot;</span><span class="p">,</span>
        <span class="n">service_description</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">service_description</span><span class="p">,</span>
        <span class="n">phone_number</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">phone_number</span><span class="p">,</span>
        <span class="n">license_plate</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_plate</span> <span class="err">??</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Use</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_number</span> <span class="ow">or</span> <span class="n">default</span> <span class="n">to</span> <span class="s2">&quot;Unknown&quot;</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">PutCommand</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

    <span class="k">return</span> <span class="err">`</span><span class="n">Successfully</span> <span class="n">added</span> <span class="n">new</span> <span class="n">service</span> <span class="n">request</span><span class="err">`</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error adding DynamoDB service request:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">throw</span> <span class="n">error</span><span class="p">;</span> <span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">throw</span> <span class="n">the</span> <span class="n">error</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span> <span class="n">further</span> <span class="n">up</span> <span class="n">the</span> <span class="n">call</span> <span class="n">stack</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">export</span> <span class="n">const</span> <span class="n">updateDynamoServiceRequest</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">requestBody</span><span class="p">,</span> <span class="n">serviceId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>

    <span class="n">const</span> <span class="n">licensePlate</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_plate</span> <span class="err">??</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">item</span> <span class="n">exists</span>
    <span class="n">const</span> <span class="n">getParams</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
      <span class="n">Key</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">service_id</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span>
        <span class="n">license_plate</span><span class="p">:</span> <span class="n">licensePlate</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="n">const</span> <span class="p">{</span> <span class="n">Item</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">GetCommand</span><span class="p">(</span><span class="n">getParams</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">Item</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No record found&quot;</span><span class="p">);</span>
    <span class="p">}</span>    

    <span class="o">//</span> <span class="n">Initialize</span> <span class="n">the</span> <span class="n">UpdateExpression</span> <span class="n">components</span>
    <span class="n">let</span> <span class="n">updateExpression</span> <span class="o">=</span> <span class="s2">&quot;set&quot;</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">expressionAttributeNames</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">const</span> <span class="n">expressionAttributeValues</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="o">//</span> <span class="n">Dynamically</span> <span class="n">build</span> <span class="n">the</span> <span class="n">UpdateExpression</span><span class="p">,</span> <span class="n">ExpressionAttributeNames</span><span class="p">,</span> <span class="ow">and</span> <span class="n">ExpressionAttributeValues</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requestBody</span><span class="o">.</span><span class="n">service_description</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">updateExpression</span> <span class="o">+=</span> <span class="s2">&quot; #sd = :sd,&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeNames</span><span class="p">[</span><span class="s2">&quot;#sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;service_description&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeValues</span><span class="p">[</span><span class="s2">&quot;:sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">service_description</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requestBody</span><span class="o">.</span><span class="n">phone_number</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">updateExpression</span> <span class="o">+=</span> <span class="s2">&quot; #pn = :pn,&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeNames</span><span class="p">[</span><span class="s2">&quot;#pn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;phone_number&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeValues</span><span class="p">[</span><span class="s2">&quot;:pn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">phone_number</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requestBody</span><span class="o">.</span><span class="n">service_status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">updateExpression</span> <span class="o">+=</span> <span class="s2">&quot; #ss = :ss,&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeNames</span><span class="p">[</span><span class="s2">&quot;#ss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;service_status&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeValues</span><span class="p">[</span><span class="s2">&quot;:ss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">service_status</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Remove</span> <span class="nb">any</span> <span class="n">trailing</span> <span class="n">comma</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">update</span> <span class="n">expression</span>
    <span class="n">updateExpression</span> <span class="o">=</span> <span class="n">updateExpression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/</span><span class="p">,</span><span class="err">$</span><span class="o">/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

    <span class="n">const</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
      <span class="n">Key</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">service_id</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span>
        <span class="n">license_plate</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_plate</span> <span class="err">??</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Assuming</span> <span class="n">license_plate</span> <span class="ow">is</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">key</span>
      <span class="p">},</span>
      <span class="n">UpdateExpression</span><span class="p">:</span> <span class="n">updateExpression</span><span class="p">,</span>
      <span class="n">ExpressionAttributeNames</span><span class="p">:</span> <span class="n">expressionAttributeNames</span><span class="p">,</span>
      <span class="n">ExpressionAttributeValues</span><span class="p">:</span> <span class="n">expressionAttributeValues</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">UpdateCommand</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

    <span class="k">await</span> <span class="n">sendSNSMessage</span><span class="p">(</span><span class="n">requestBody</span><span class="p">,</span><span class="n">serviceId</span><span class="p">);</span>

    <span class="k">return</span> <span class="err">`</span><span class="n">Successfully</span> <span class="n">updated</span> <span class="n">service</span> <span class="n">request</span><span class="err">`</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">message</span> <span class="o">===</span> <span class="s2">&quot;No record found&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error updating DynamoDB service request:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
      <span class="n">throw</span> <span class="n">error</span><span class="p">;</span> <span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">throw</span> <span class="n">the</span> <span class="n">error</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span> <span class="n">further</span> <span class="n">up</span> <span class="n">the</span> <span class="n">call</span> <span class="n">stack</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>



<span class="o">//</span> <span class="n">Helper</span> <span class="n">function</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">a</span> <span class="n">unique</span> <span class="n">service_id</span> <span class="n">based</span> <span class="n">on</span> <span class="n">current</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">time</span>
<span class="n">const</span> <span class="n">generateServiceId</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="n">const</span> <span class="n">now</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Date</span><span class="p">();</span>
  <span class="n">const</span> <span class="n">formattedDate</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">toISOString</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/</span><span class="p">[</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="o">.</span><span class="n">Z</span><span class="p">]</span><span class="o">/</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="o">//</span> <span class="n">Format</span> <span class="n">date</span> <span class="n">string</span>
  <span class="n">const</span> <span class="n">milliseconds</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">getMilliseconds</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="o">.</span><span class="n">padStart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">);</span> <span class="o">//</span> <span class="n">Get</span> <span class="n">milliseconds</span> <span class="ow">and</span> <span class="n">pad</span> <span class="k">with</span> <span class="n">leading</span> <span class="n">zeros</span> <span class="k">if</span> <span class="n">necessary</span>
  <span class="k">return</span> <span class="err">`$</span><span class="p">{</span><span class="n">formattedDate</span><span class="p">}</span><span class="err">$</span><span class="p">{</span><span class="n">milliseconds</span><span class="p">}</span><span class="err">`</span><span class="p">;</span> <span class="o">//</span> <span class="n">Concatenate</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">milliseconds</span>
<span class="p">};</span>

<span class="k">async</span> <span class="n">function</span> <span class="n">sendSNSMessage</span><span class="p">(</span><span class="n">requestBody</span><span class="p">,</span> <span class="n">serviceId</span><span class="p">){</span>
    <span class="n">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SNSClient</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span> <span class="o">//</span> <span class="n">PublishInput</span>
      <span class="n">TopicArn</span><span class="p">:</span> <span class="s2">&quot;REPLACE-WITH-YOUR-TOPIC-ARN&quot;</span><span class="p">,</span>
      <span class="n">Message</span><span class="p">:</span> <span class="err">`</span><span class="p">{</span><span class="s2">&quot;service_status&quot;</span><span class="p">:</span><span class="s2">&quot;$</span><span class="si">{requestBody.service_status}</span><span class="s2">&quot;</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
      <span class="n">Subject</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span>
      <span class="n">MessageAttributes</span><span class="p">:</span> <span class="p">{</span> <span class="o">//</span> <span class="n">MessageAttributeMap</span>
        <span class="s2">&quot;service_status&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">//</span> <span class="n">MessageAttributeValue</span>
          <span class="n">DataType</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">required</span>
          <span class="n">StringValue</span><span class="p">:</span> <span class="err">`$</span><span class="p">{</span><span class="n">requestBody</span><span class="o">.</span><span class="n">service_status</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
      <span class="o">//</span> <span class="n">MessageDeduplicationId</span><span class="p">:</span> <span class="err">`$</span><span class="p">{</span><span class="n">requestBody</span><span class="o">.</span><span class="n">service_id</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
      <span class="o">//</span> <span class="n">MessageGroupId</span><span class="p">:</span> <span class="err">`$</span><span class="p">{</span><span class="n">requestBody</span><span class="o">.</span><span class="n">service_id</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="n">const</span> <span class="n">command</span> <span class="o">=</span> <span class="n">new</span> <span class="n">PublishCommand</span><span class="p">(</span><span class="nb">input</span><span class="p">);</span>
    <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>  
<span class="p">}</span>
</code></pre></div>

<p>You'll need to go get the Topic ARN from the SNS Topic <strong>VehicleStatus</strong>. You'll update the code where it says "REPLACE-WITH-YOUR-TOPIC-ARN" with the ARN of your Topic.</p>
<p>Once you've made the update, go to your website and submit a service request. Type in a phone number, license plate number, and the message requesting an oil change for a 2020 Corvette.</p>
<p>Then log into the admin area and then change the status for that service to Approved.</p>
<p>Go look at the queues. You should see the message under one but not the other.</p>
<p>Update the status to Completed from the admin area.</p>
<p>Go look at the queues. You should see the new message under both.</p>
<h2 id="add-a-lambda-to-run-when-a-message-is-received">Add a lambda to run when a message is received</h2>
<p>Create a new lambda function named VehicleAnalytics. </p>
<p>Add this code to the index.mjs file:</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">implement</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">statusCode</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">    </span><span class="n">body</span><span class="p">:</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="s1">&#39;Status Updated!&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">event</span><span class="p">),</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">      </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;status updated!&quot;</span><span class="o">+</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">Records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">details</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Message ID:&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="o">.</span><span class="n">messageId</span><span class="p">);</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Receipt Handle:&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="o">.</span><span class="n">receiptHandle</span><span class="p">);</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Body:&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="o">.</span><span class="n">body</span><span class="p">);</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span><span class="w"> </span><span class="n">interact</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="n">services</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span><span class="p">)</span>
<span class="w">        </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">messageBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">body</span><span class="p">);</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Example</span><span class="p">:</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">parsed</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">body</span>
<span class="w">            </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Parsed Message Body:&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">messageBody</span><span class="p">);</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">processing</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="n">here</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">fullMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">messageBody</span><span class="o">.</span><span class="n">Message</span><span class="p">);</span>
<span class="w">            </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Full Message:&quot;</span><span class="p">,</span><span class="n">fullMessage</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error processing message:&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span><span class="w">    </span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>Go to the SQS queue for the <strong>AllStatusUpdatesQueue</strong></p>
<ul>
<li>Click the lambda trigger tab</li>
<li>Click Configure Lambda function trigger</li>
<li>Choose the VehicleAnalysis function</li>
<li>Click Save</li>
</ul>
<p>Go look at the queue. You'll notice that the messages are now gone from that queue. Once a message is processed by a lambda with a 200 status, it will automatically be deleted from the queue. </p>
<p>You can now go to the CloudWatch service and look at the <em>log groups</em> for the <em>VehicleAnalytics</em>.</p>
<p><img alt="CloudWatch Log Groups" src="https://byui-cse.github.io/itm300-course/shared/img/cloudwatch-log-groups.jpg" /></p>
<p>There you should see logs that have information about the two updates you did previously. These logs could then be used to create dashboards and visualizations of the services performed over time.</p>
<p><img alt="CloudWatch SNS Log" src="https://byui-cse.github.io/itm300-course/shared/img/cloudwatch-sns-message-log.jpg" /></p>
<p>Outside of the lab environment, SNS can be utilized to send emails and text messages, which can be very useful for notifying customers about the status of their vehicles or informing them that their car is ready for pickup.</p>
<p>By integrating SNS and SQS, we can effortlessly add new workflows to various activities without requiring the original service to be aware of the additional pipelines that have been established.</p>
<h2 id="lab-summary">Lab Summary</h2>
<p>This lab focuses on utilizing AWS Simple Notification Service (SNS) and Simple Queue Service (SQS) to create a messaging system that can notify various services about changes in vehicle service statuses. The key objectives include setting up SNS topics and SQS queues, configuring subscriptions, filtering messages, sending and receiving messages, and integrating these functionalities into a Lambda function for further processing.</p>
<h3 id="key-concepts-explained">Key Concepts Explained:</h3>
<ul>
<li><strong>Decoupled Architecture:</strong> By using SNS and SQS, the lab demonstrates how to decouple different parts of an application. This architecture allows independent scaling and development of various components without affecting others.</li>
<li><strong>Asynchronous Messaging:</strong> SNS and SQS enable asynchronous communication between services. This is crucial for handling tasks that do not require immediate responses, improving the application's overall efficiency and responsiveness.</li>
<li><strong>Message Filtering:</strong> SNS message filtering allows targeted messages to be sent to specific queues based on message attributes. This reduces unnecessary processing and ensures that only relevant messages are received by specific services.</li>
<li><strong>Event-Driven Processing:</strong> The integration of Lambda functions with SNS and SQS illustrates event-driven processing, where actions are triggered in response to specific events (e.g., updates to vehicle service status).</li>
<li><strong>Scalability and Flexibility:</strong> Using SNS and SQS provides a scalable and flexible solution for handling increasing volumes of messages and integrating new services or workflows without significant changes to the existing system.</li>
</ul>
<h2 id="key-aws-services">Key AWS Services:</h2>
<ul>
<li><strong>Simple Notification Service (SNS):</strong> SNS is a fully managed service that enables the delivery of messages to various endpoints such as email, SMS, and other AWS services. It acts as a publisher in the publish-subscribe (pub/sub) model.</li>
<li><strong>Simple Queue Service (SQS):</strong> SQS is a fully managed message queuing service that allows you to decouple and scale microservices, distributed systems, and serverless applications. It acts as a subscriber in the pub/sub model, receiving and storing messages until they are processed.</li>
<li><strong>CloudWatch:</strong> CloudWatch is a monitoring and observability service that provides data and actionable insights for AWS resources. It is used in this lab to monitor and log the processing of messages in Lambda functions.</li>
</ul>
<h3 id="reflection-questions">Reflection Questions:</h3>
<ul>
<li><strong>Understanding the Workflow:</strong> How does the integration of SNS and SQS enhance the scalability and flexibility of the notification system in this project? What are the advantages of using message filtering in SNS subscriptions?</li>
<li><strong>Lambda Function Integration:</strong> How does updating the Lambda function to publish SNS messages streamline the process of service status updates? What other AWS services could you integrate with this system to enhance functionality?</li>
<li><strong>Real-World Applications:</strong> How could this messaging system be adapted for use in different industries or applications outside of vehicle service notifications? What are the potential benefits and challenges of using SNS and SQS for customer notifications in a high-traffic environment?</li>
<li><strong>Error Handling and Logging:</strong> Why is it important to handle errors and log messages in the Lambda function processing the SQS messages? How would you improve the error handling and logging mechanisms in this lab?</li>
<li><strong>Further Improvements:</strong> What additional features or services could be integrated into this system to improve its functionality and reliability? How would you modify the system to handle larger volumes of messages or more complex workflows?</li>
</ul>
	</article>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/highlight/highlight.pack.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.js"></script>
    <script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/contrib/auto-render.min.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/smartquotes/smartquotes.min.js"></script>
    <script>

        /* Startup scripts for katex rendering */
    	renderMathInElement(document.body,
		{
			delimiters: [
				{left: "$$", right: "$$", display: true},
				{left: "$", right: "$", display: false},
			]
    	});

        /* Highlighting code */
    	hljs.initHighlightingOnLoad();
    	var elements = document.querySelectorAll('.language-text')
		for (var i = 0; i < elements.length; i++) {
  			elements[i].classList.add('hljs');
		}

        /* TOC support */
        var hideContents = function(e){
            console.log(e.target);
            if(e.target.id === 'modal-screen' || e.target.nodeName.toLowerCase() === 'i') {
                e.preventDefault();
                document.querySelector('#contents-wrapper').classList.remove('active');
                document.querySelector('#modal-screen').classList.remove('active');
            }
        }

        var showContents = function(e){
            e.preventDefault();
            document.querySelector('#contents-wrapper').classList.add('active');
            document.querySelector('#modal-screen').classList.add('active');
        }

        document.querySelector("#hide-contents").addEventListener('click', hideContents);
        document.querySelector("#modal-screen").addEventListener('click', hideContents);
        document.querySelector("#show-contents").addEventListener('click', showContents);
    	
    </script>
</body>
</html>