<!DOCTYPE html>
<html>
<head>
	<title>Module 07: Project 7 Lab - Admin Secure Pages</title>
    <style>
        @font-face {
            font-family: 'icomoon';
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot');
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot#iefix-8k8p81') format('embedded-opentype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.ttf') format('truetype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.woff') format('woff'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.svg#icomoon') format('svg');
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/reset.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/fonts/fontawesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/highlight/styles/monokai-sublime.min.css">
	<link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/cse450.css?v1.5.2">
    <meta charset="utf-8">

</head>
<body class="index-page">
     <div id="modal-screen">
        <div id="contents-wrapper">
            <div class="toc">
<ul>
<li><a href="#product-objective">Product Objective</a></li>
<li><a href="#instructions">Instructions</a></li>
<li><a href="#create-a-new-api-gateway-resource">Create a new API Gateway resource</a></li>
<li><a href="#create-an-authorizer">Create an authorizer</a></li>
<li><a href="#create-lambda">Create lambda</a></li>
<li><a href="#create-a-get-method">Create a Get Method</a></li>
<li><a href="#update-code">Update code</a></li>
</ul>
</div>

            <a href="#" id="hide-contents" title="Close Table of Contents"><i class="far fa-window-close"></i></a>
        </div>
    </div>
	<header>
        <span class="icon-byui-logo"></span>
        <div id="titles">
            <h1>ITM 300 - Cloud Foundations</h1>
            <h2>Module 07: Project 7 Lab - Admin Secure Pages</h2>
            <nav><a href="https://byui-cse.github.io/itm300-course"><i class="fas fa-home"></i></a><a href="https://byui-cse.github.io/itm300-course/modules/">Modules</a><a href="https://byui-cse.github.io/itm300-course/test-prep/">Test Prep</a></nav>
        </div>
        <a href="#" id="show-contents" title="Show Table of Contents"><i class="far fa-list-alt"></i></a>
    </header>
	<article>
		<p><img alt="Quick Oil Change and Repair" src="https://byui-cse.github.io/itm300-course/shared/img/quick-logo-service-requests.jpg" />
<em><a href="https://openai.com/dall-e-3">Photo by Dall-E-3</a></em></p>
<h2 id="product-objective">Product Objective</h2>
<p>For this lab we'll build and integrate an API to handle data securely for the technicians.</p>
<h2 id="instructions">Instructions</h2>
<h2 id="create-a-new-api-gateway-resource">Create a new API Gateway resource</h2>
<p>We'll add a new endpoint which will provide a secure location for our logged in users to pull information. </p>
<p>Go to our vehicleapp API Gateway. Click on the /.</p>
<ul>
<li>Click Create resource</li>
<li>Resource Name: admin-service-request</li>
<li>Check CORS  </li>
</ul>
<p><img alt="admin-service-request" src="https://byui-cse.github.io/itm300-course/shared/img/admin-service-request.jpg" /></p>
<h2 id="create-an-authorizer">Create an authorizer</h2>
<p>We can enhance our API Gateway endpoint by integrating an authorizer. By linking our Cognito service to the endpoint, we can verify that each request includes a valid token. The gateway will verify this token before executing the code, providing an added layer of security.</p>
<ul>
<li>Left hand side of the API Gateway</li>
<li>Name: AdminServiceRequestAuthorizer</li>
<li>Cognito</li>
<li>Choose VehicleApp</li>
<li>Token Source: Authorization</li>
</ul>
<h2 id="create-lambda">Create lambda</h2>
<ul>
<li>Name: adminGetServiceRequest</li>
<li>Role: LabRole</li>
</ul>
<p>create a file named adminDynamoService.mjs</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="p">{</span> <span class="n">DynamoDBClient</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/client-dynamodb&quot;</span><span class="p">;</span>
<span class="kn">import</span> <span class="p">{</span>
  <span class="n">DynamoDBDocumentClient</span><span class="p">,</span>
  <span class="n">ScanCommand</span><span class="p">,</span>
  <span class="n">PutCommand</span><span class="p">,</span>
  <span class="n">GetCommand</span><span class="p">,</span>
  <span class="n">DeleteCommand</span><span class="p">,</span>
  <span class="n">UpdateCommand</span><span class="p">,</span>
<span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/lib-dynamodb&quot;</span><span class="p">;</span>

<span class="n">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DynamoDBClient</span><span class="p">({});</span>

<span class="n">const</span> <span class="n">mydynamodb</span> <span class="o">=</span> <span class="n">DynamoDBDocumentClient</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

<span class="n">const</span> <span class="n">tableName</span> <span class="o">=</span> <span class="s2">&quot;VehicleServices&quot;</span><span class="p">;</span>    

<span class="n">export</span> <span class="n">const</span> <span class="n">getDynamoServiceRequests</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">statusToExclude</span> <span class="o">=</span> <span class="s2">&quot;Completed&quot;</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">const</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
            <span class="n">FilterExpression</span><span class="p">:</span> <span class="s2">&quot;attribute_not_exists(service_status) OR #service_status &lt;&gt; :status&quot;</span><span class="p">,</span>
            <span class="n">ExpressionAttributeNames</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;#service_status&quot;</span><span class="p">:</span> <span class="s2">&quot;service_status&quot;</span>
            <span class="p">},</span>
            <span class="n">ExpressionAttributeValues</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;:status&quot;</span><span class="p">:</span> <span class="n">statusToExclude</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">};</span>      
        <span class="n">const</span> <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">ScanCommand</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">Items</span><span class="p">;</span> <span class="o">//</span> <span class="n">Return</span> <span class="n">JSON</span> <span class="n">string</span> <span class="n">of</span> <span class="n">items</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error fetching DynamoDB service requests:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
        <span class="n">throw</span> <span class="n">error</span><span class="p">;</span> <span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">throw</span> <span class="n">the</span> <span class="n">error</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span> <span class="n">further</span> <span class="n">up</span> <span class="n">the</span> <span class="n">call</span> <span class="n">stack</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">export</span> <span class="n">const</span> <span class="n">addDynamoServiceRequest</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">requestBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">serviceId</span> <span class="o">=</span> <span class="n">generateServiceId</span><span class="p">();</span> <span class="o">//</span> <span class="n">Generate</span> <span class="n">unique</span> <span class="n">service_id</span> <span class="n">based</span> <span class="n">on</span> <span class="n">current</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">time</span>      
    <span class="n">const</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
      <span class="n">Item</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">service_id</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span> <span class="o">//</span> <span class="n">Assuming</span> <span class="n">service_id</span> <span class="ow">is</span> <span class="n">provided</span> <span class="ow">in</span> <span class="n">requestBody</span>
        <span class="n">service_status</span><span class="p">:</span> <span class="s2">&quot;New Request&quot;</span><span class="p">,</span>
        <span class="n">service_description</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">service_description</span><span class="p">,</span>
        <span class="n">phone_number</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">phone_number</span><span class="p">,</span>
        <span class="n">license_plate</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_plate</span> <span class="err">??</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Use</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_number</span> <span class="ow">or</span> <span class="n">default</span> <span class="n">to</span> <span class="s2">&quot;Unknown&quot;</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">PutCommand</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

    <span class="k">return</span> <span class="err">`</span><span class="n">Successfully</span> <span class="n">added</span> <span class="n">new</span> <span class="n">service</span> <span class="n">request</span><span class="err">`</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error adding DynamoDB service request:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">throw</span> <span class="n">error</span><span class="p">;</span> <span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">throw</span> <span class="n">the</span> <span class="n">error</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span> <span class="n">further</span> <span class="n">up</span> <span class="n">the</span> <span class="n">call</span> <span class="n">stack</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">export</span> <span class="n">const</span> <span class="n">updateDynamoServiceRequest</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">requestBody</span><span class="p">,</span> <span class="n">serviceId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>

    <span class="n">const</span> <span class="n">licensePlate</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_plate</span> <span class="err">??</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">item</span> <span class="n">exists</span>
    <span class="n">const</span> <span class="n">getParams</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
      <span class="n">Key</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">service_id</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span>
        <span class="n">license_plate</span><span class="p">:</span> <span class="n">licensePlate</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="n">const</span> <span class="p">{</span> <span class="n">Item</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">GetCommand</span><span class="p">(</span><span class="n">getParams</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">Item</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No record found&quot;</span><span class="p">);</span>
    <span class="p">}</span>    

    <span class="o">//</span> <span class="n">Initialize</span> <span class="n">the</span> <span class="n">UpdateExpression</span> <span class="n">components</span>
    <span class="n">let</span> <span class="n">updateExpression</span> <span class="o">=</span> <span class="s2">&quot;set&quot;</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">expressionAttributeNames</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">const</span> <span class="n">expressionAttributeValues</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="o">//</span> <span class="n">Dynamically</span> <span class="n">build</span> <span class="n">the</span> <span class="n">UpdateExpression</span><span class="p">,</span> <span class="n">ExpressionAttributeNames</span><span class="p">,</span> <span class="ow">and</span> <span class="n">ExpressionAttributeValues</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requestBody</span><span class="o">.</span><span class="n">service_description</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">updateExpression</span> <span class="o">+=</span> <span class="s2">&quot; #sd = :sd,&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeNames</span><span class="p">[</span><span class="s2">&quot;#sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;service_description&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeValues</span><span class="p">[</span><span class="s2">&quot;:sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">service_description</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requestBody</span><span class="o">.</span><span class="n">phone_number</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">updateExpression</span> <span class="o">+=</span> <span class="s2">&quot; #pn = :pn,&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeNames</span><span class="p">[</span><span class="s2">&quot;#pn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;phone_number&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeValues</span><span class="p">[</span><span class="s2">&quot;:pn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">phone_number</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requestBody</span><span class="o">.</span><span class="n">service_status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">updateExpression</span> <span class="o">+=</span> <span class="s2">&quot; #ss = :ss,&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeNames</span><span class="p">[</span><span class="s2">&quot;#ss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;service_status&quot;</span><span class="p">;</span>
      <span class="n">expressionAttributeValues</span><span class="p">[</span><span class="s2">&quot;:ss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">service_status</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Remove</span> <span class="nb">any</span> <span class="n">trailing</span> <span class="n">comma</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">update</span> <span class="n">expression</span>
    <span class="n">updateExpression</span> <span class="o">=</span> <span class="n">updateExpression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/</span><span class="p">,</span><span class="err">$</span><span class="o">/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

    <span class="n">const</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
      <span class="n">Key</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">service_id</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span>
        <span class="n">license_plate</span><span class="p">:</span> <span class="n">requestBody</span><span class="o">.</span><span class="n">license_plate</span> <span class="err">??</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Assuming</span> <span class="n">license_plate</span> <span class="ow">is</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">key</span>
      <span class="p">},</span>
      <span class="n">UpdateExpression</span><span class="p">:</span> <span class="n">updateExpression</span><span class="p">,</span>
      <span class="n">ExpressionAttributeNames</span><span class="p">:</span> <span class="n">expressionAttributeNames</span><span class="p">,</span>
      <span class="n">ExpressionAttributeValues</span><span class="p">:</span> <span class="n">expressionAttributeValues</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">UpdateCommand</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

    <span class="k">return</span> <span class="err">`</span><span class="n">Successfully</span> <span class="n">updated</span> <span class="n">service</span> <span class="n">request</span><span class="err">`</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">message</span> <span class="o">===</span> <span class="s2">&quot;No record found&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error updating DynamoDB service request:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
      <span class="n">throw</span> <span class="n">error</span><span class="p">;</span> <span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">throw</span> <span class="n">the</span> <span class="n">error</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span> <span class="n">further</span> <span class="n">up</span> <span class="n">the</span> <span class="n">call</span> <span class="n">stack</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>



<span class="o">//</span> <span class="n">Helper</span> <span class="n">function</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">a</span> <span class="n">unique</span> <span class="n">service_id</span> <span class="n">based</span> <span class="n">on</span> <span class="n">current</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">time</span>
<span class="n">const</span> <span class="n">generateServiceId</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="n">const</span> <span class="n">now</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Date</span><span class="p">();</span>
  <span class="n">const</span> <span class="n">formattedDate</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">toISOString</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/</span><span class="p">[</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="o">.</span><span class="n">Z</span><span class="p">]</span><span class="o">/</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="o">//</span> <span class="n">Format</span> <span class="n">date</span> <span class="n">string</span>
  <span class="n">const</span> <span class="n">milliseconds</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">getMilliseconds</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="o">.</span><span class="n">padStart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">);</span> <span class="o">//</span> <span class="n">Get</span> <span class="n">milliseconds</span> <span class="ow">and</span> <span class="n">pad</span> <span class="k">with</span> <span class="n">leading</span> <span class="n">zeros</span> <span class="k">if</span> <span class="n">necessary</span>
  <span class="k">return</span> <span class="err">`$</span><span class="p">{</span><span class="n">formattedDate</span><span class="p">}</span><span class="err">$</span><span class="p">{</span><span class="n">milliseconds</span><span class="p">}</span><span class="err">`</span><span class="p">;</span> <span class="o">//</span> <span class="n">Concatenate</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">milliseconds</span>
<span class="p">};</span>
</code></pre></div>

<p>Update the index.mjs with the following code:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="p">{</span> <span class="n">getDynamoServiceRequests</span><span class="p">,</span> <span class="n">addDynamoServiceRequest</span><span class="p">,</span> <span class="n">updateDynamoServiceRequest</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;./adminDynamoService.mjs&#39;</span><span class="p">;</span>

<span class="n">const</span> <span class="n">commonHeaders</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">:</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">:</span> <span class="s1">&#39;OPTIONS,POST,GET,PUT&#39;</span>
<span class="p">};</span>

<span class="n">export</span> <span class="n">const</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>

    <span class="n">const</span> <span class="n">httpMethod</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">httpMethod</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">path</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">path</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">resource</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">pathParameters</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pathParameters</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">queryParameters</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">queryStringParameters</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">body</span> <span class="err">?</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="p">:</span> <span class="n">null</span><span class="p">;</span>    
    <span class="n">let</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="n">switch</span> <span class="p">(</span><span class="n">httpMethod</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>    
        <span class="n">jsonArray</span> <span class="o">=</span> <span class="k">await</span> <span class="n">getDynamoServiceRequests</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;puting&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pathParameters</span> <span class="o">&amp;&amp;</span> <span class="n">pathParameters</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">jsonArray</span> <span class="o">=</span> <span class="k">await</span> <span class="n">updateDynamoServiceRequest</span><span class="p">(</span><span class="n">requestBody</span><span class="p">,</span><span class="n">pathParameters</span><span class="o">.</span><span class="n">id</span><span class="p">);</span>
          <span class="o">//</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="err">`$</span><span class="p">{</span><span class="n">pathParameters</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">requestBody</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="n">jsonArray</span> <span class="o">=</span> <span class="s2">&quot;Missing ID&quot;</span>
        <span class="p">}</span>
        <span class="o">//</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="s2">&quot;Posted&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="n">body</span><span class="p">:</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">jsonArray</span><span class="p">),</span>
      <span class="n">headers</span><span class="p">:</span> <span class="n">commonHeaders</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">statusCode</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
      <span class="n">body</span><span class="p">:</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">({</span> <span class="n">message</span><span class="p">:</span> <span class="s1">&#39;Internal Server Error&#39;</span> <span class="p">}),</span>
      <span class="n">headers</span><span class="p">:</span> <span class="n">commonHeaders</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="create-a-get-method">Create a Get Method</h2>
<ul>
<li>Create Method</li>
<li>Get</li>
<li>Lambda Proxy: turn on</li>
<li>lambda: adminGetServiceRequest</li>
</ul>
<p>Authorization: AdminServiceRequestAuthorizer</p>
<ul>
<li>Create resource / {id}</li>
<li>
<p>check CORS </p>
</li>
<li>
<p>Create Method: PUT</p>
</li>
<li>Lambda</li>
<li>Lambda Proxy Integration</li>
<li>adminGetServiceRequest</li>
</ul>
<p>Edit : Authorization: AdminServiceRequestAuthorizer</p>
<p>Deploy API</p>
<h2 id="update-code">Update code</h2>
<p>Connect to your Vehicle App EC2 Instance</p>
<p>Download the newest website app:</p>
<div class="codehilite"><pre><span></span><code>wget https://github.com/byui-cse/itm300-course/raw/main/source/module-07/rebuildapp.sh
</code></pre></div>

<div class="codehilite"><pre><span></span><code>chmod +x ./rebuildapp.sh
</code></pre></div>

<p>Next run the script which will download the newest files. </p>
<div class="codehilite"><pre><span></span><code>sudo bash ./rebuildapp.sh
</code></pre></div>

<p>You'll be prompted to enter multiple settings.</p>
	</article>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/highlight/highlight.pack.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.js"></script>
    <script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/contrib/auto-render.min.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/smartquotes/smartquotes.min.js"></script>
    <script>

        /* Startup scripts for katex rendering */
    	renderMathInElement(document.body,
		{
			delimiters: [
				{left: "$$", right: "$$", display: true},
				{left: "$", right: "$", display: false},
			]
    	});

        /* Highlighting code */
    	hljs.initHighlightingOnLoad();
    	var elements = document.querySelectorAll('.language-text')
		for (var i = 0; i < elements.length; i++) {
  			elements[i].classList.add('hljs');
		}

        /* TOC support */
        var hideContents = function(e){
            console.log(e.target);
            if(e.target.id === 'modal-screen' || e.target.nodeName.toLowerCase() === 'i') {
                e.preventDefault();
                document.querySelector('#contents-wrapper').classList.remove('active');
                document.querySelector('#modal-screen').classList.remove('active');
            }
        }

        var showContents = function(e){
            e.preventDefault();
            document.querySelector('#contents-wrapper').classList.add('active');
            document.querySelector('#modal-screen').classList.add('active');
        }

        document.querySelector("#hide-contents").addEventListener('click', hideContents);
        document.querySelector("#modal-screen").addEventListener('click', hideContents);
        document.querySelector("#show-contents").addEventListener('click', showContents);
    	
    </script>
</body>
</html>