<!DOCTYPE html>
<html>
<head>
	<title>Module 04: Project 4 Lab - REST API Gateway</title>
    <style>
        @font-face {
            font-family: 'icomoon';
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot');
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot#iefix-8k8p81') format('embedded-opentype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.ttf') format('truetype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.woff') format('woff'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.svg#icomoon') format('svg');
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/reset.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/fonts/fontawesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/highlight/styles/monokai-sublime.min.css">
	<link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/cse450.css?v1.5.2">
    <meta charset="utf-8">

</head>
<body class="index-page">
     <div id="modal-screen">
        <div id="contents-wrapper">
            <div class="toc">
<ul>
<li><a href="#product-objective">Product Objective</a></li>
<li><a href="#instructions">Instructions</a></li>
<li><a href="#create-a-lambda-function">Create a Lambda Function</a></li>
<li><a href="#create-the-api-gateway">Create the API Gateway</a></li>
<li><a href="#update-the-app-files">Update the app files</a></li>
</ul>
</div>

            <a href="#" id="hide-contents" title="Close Table of Contents"><i class="far fa-window-close"></i></a>
        </div>
    </div>
	<header>
        <span class="icon-byui-logo"></span>
        <div id="titles">
            <h1>ITM 300 - Cloud Foundations</h1>
            <h2>Module 04: Project 4 Lab - REST API Gateway</h2>
            <nav><a href="https://byui-cse.github.io/itm300-course"><i class="fas fa-home"></i></a><a href="https://byui-cse.github.io/itm300-course/modules/">Modules</a><a href="https://byui-cse.github.io/itm300-course/test-prep/">Test Prep</a></nav>
        </div>
        <a href="#" id="show-contents" title="Show Table of Contents"><i class="far fa-list-alt"></i></a>
    </header>
	<article>
		<p><img alt="Quick Oil Change and Repair" src="https://byui-cse.github.io/itm300-course/shared/img/quick-logo-service-requests.jpg" />
<em><a href="https://openai.com/dall-e-3">Photo by Dall-E-3</a></em></p>
<h2 id="product-objective">Product Objective</h2>
<p>You will be connecting your website to an API gateway which will return back service requests. A lambda function will generate the json that will contain the information about the service requests which will be sent back to the app. For now, we'll just hard code the json, but later we'll pull the information dynamically.</p>
<h2 id="instructions">Instructions</h2>
<p>We will do three main steps in this lab. First we will create a lambda function which will generate json data containing service request information. This information will be displayed on our app as well as in the shop to let customer's know which vehicles are currently being worked on.</p>
<p>Second, we'll create an API gateway and an <strong>endpoint</strong> that we can connect to. This enpoint will return back the information provided by the lambda function.</p>
<p>Third, we'll update our app code to display the current service requests.</p>
<h2 id="create-a-lambda-function">Create a Lambda Function</h2>
<p>Search for Lambda in AWS</p>
<ul>
<li>Create function</li>
<li>Author from scratch</li>
<li>
<p>Function Name: getServiceRequest</p>
</li>
<li>
<p>Change default execution role: Use an existing Role: LabRole</p>
</li>
</ul>
<p>Update index.mjs with:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="p">{</span> <span class="n">getServiceRequests</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;./dataService.mjs&#39;</span><span class="p">;</span>

<span class="n">export</span> <span class="n">const</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;here&quot;</span><span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="n">getServiceRequests</span><span class="p">();</span>
    <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>

      <span class="n">body</span><span class="p">:</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">jsonArray</span><span class="p">),</span>
      <span class="n">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="s2">&quot;Access-Control-Allow-Headers&quot;</span> <span class="p">:</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">:</span> <span class="s2">&quot;OPTIONS,POST,GET,PUT&quot;</span>        
      <span class="p">},</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">statusCode</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
      <span class="n">body</span><span class="p">:</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">({</span> <span class="n">message</span><span class="p">:</span> <span class="s1">&#39;Internal Server Error&#39;</span> <span class="p">}),</span>
      <span class="n">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="s2">&quot;Access-Control-Allow-Headers&quot;</span> <span class="p">:</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">:</span> <span class="s2">&quot;OPTIONS,POST,GET,PUT&quot;</span>          
      <span class="p">},</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">HTTP Status Codes</p>
<p>We return one of two status codes depending on if the function does what it is supposed to do.</p>
<p><strong>200</strong> OK: This means everything went well.</p>
<p><strong>500</strong> Internal Server Error</p>
<p>The preparation material for this week has videos that go into what each status code is. We'll use more in the future as well as using different HTTP verbs besides GET.</p>
</div>
<p>Create a file named dataService.mjs</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">getServiceRequests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">phone</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;208-555-5555&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Oil Change on a 2007 Saturn Outlook&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">phone</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;208-555-9999&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I need the brakes fixed on my 2010 Buick LeSabre&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">phone</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;208-555-9111&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;My radiator exploded. Help!&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>

<p>Click Test</p>
<p>Give the Test a name and then click Invoke. You should receive a response similar to this:</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;statusCode&quot;: 200,
  &quot;body&quot;: &quot;[{\&quot;id\&quot;:1,\&quot;phone\&quot;:\&quot;208-555-5555\&quot;,\&quot;service\&quot;:\&quot;Oil Change on a 2007 Saturn Outlook\&quot;},{\&quot;id\&quot;:2,\&quot;phone\&quot;:\&quot;208-555-9999\&quot;,\&quot;service\&quot;:\&quot;I need the brakes fixed on my 2010 Buick LeSabre\&quot;},{\&quot;id\&quot;:3,\&quot;phone\&quot;:\&quot;208-555-9111\&quot;,\&quot;service\&quot;:\&quot;My radiator exploded. Help!\&quot;}]&quot;,
  &quot;headers&quot;: {
    &quot;Content-Type&quot;: &quot;application/json&quot;,
    &quot;Access-Control-Allow-Headers&quot;: &quot;Content-Type&quot;,
    &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,
    &quot;Access-Control-Allow-Methods&quot;: &quot;OPTIONS,POST,GET,PUT&quot;
  }
}
</code></pre></div>

<p>Deploy the Lambda function by clicking the Deploy button</p>
<div class="admonition key">
<p class="admonition-title">Don't forget to Deploy</p>
<p>If you make any changes to your function, you must click Deploy to deploy the new changes. </p>
</div>
<h2 id="create-the-api-gateway">Create the API Gateway</h2>
<p>Search for API Gateway.</p>
<p>Scroll down to REST API and Click <strong>Build</strong></p>
<ul>
<li>New API</li>
<li>
<p>API Name : vehicleapp</p>
</li>
<li>
<p>API endpoint type: Regional</p>
</li>
<li>
<p>Create API</p>
</li>
<li>
<p>Create resource:</p>
<ul>
<li>Resource path: /</li>
<li>Resource name: service-request</li>
<li>CORS checked</li>
</ul>
</li>
<li>
<p>Click /service-request</p>
<ul>
<li>
<p>Create method</p>
</li>
<li>
<p>Method type: GET</p>
</li>
<li>Integration type: Lambda Function</li>
<li>TURN ON LAMBDA PROXY INTEGRATION</li>
<li>Lambda Function (make sure your region is correct): getServiceRequest</li>
</ul>
</li>
</ul>
<p>Before we deploy the API you should test the API to make sure it is returning the correct data.</p>
<p>Click the <strong>Test</strong> tab and then click the Test button. You should get a response like this:</p>
<div class="codehilite"><pre><span></span><code>Response body

[{&quot;id&quot;:1,&quot;phone&quot;:&quot;208-555-5555&quot;,&quot;service&quot;:&quot;Oil Change on a 2007 Saturn Outlook&quot;},{&quot;id&quot;:2,&quot;phone&quot;:&quot;208-555-9999&quot;,&quot;service&quot;:&quot;I need the brakes fixed on my 2010 Buick LeSabre&quot;},{&quot;id&quot;:3,&quot;phone&quot;:&quot;208-555-9111&quot;,&quot;service&quot;:&quot;My radiator exploded. Help!&quot;}]

Response headers

{
  &quot;Access-Control-Allow-Headers&quot;: &quot;Content-Type&quot;,
  &quot;Access-Control-Allow-Methods&quot;: &quot;OPTIONS,POST,GET,PUT&quot;,
  &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,
  &quot;Content-Type&quot;: &quot;application/json&quot;,...
</code></pre></div>

<ul>
<li>
<p>Click Deploy API</p>
<ul>
<li>State: New Stage</li>
<li>Stage Name: prod</li>
</ul>
</li>
</ul>
<h2 id="update-the-app-files">Update the app files</h2>
<p>Upload the new files to your webserver</p>
<div class="codehilite"><pre><span></span><code><span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">byui</span><span class="o">-</span><span class="n">cse</span><span class="o">/</span><span class="n">itm300</span><span class="o">-</span><span class="n">course</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">source</span><span class="o">/</span><span class="n">module</span><span class="o">-</span><span class="mi">03</span><span class="o">/</span><span class="n">quick</span><span class="o">-</span><span class="n">oil</span><span class="o">-</span><span class="n">part3</span><span class="o">.</span><span class="n">zip</span>
<span class="n">mkdir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">lab</span><span class="o">-</span><span class="n">app</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/*</span>
<span class="n">unzip</span><span class="w"> </span><span class="n">quick</span><span class="o">-</span><span class="n">oil</span><span class="o">-</span><span class="n">part4</span><span class="o">.</span><span class="n">zip</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">lab</span><span class="o">-</span><span class="n">app</span>
<span class="n">mv</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">lab</span><span class="o">-</span><span class="n">app</span><span class="o">/</span><span class="n">quick</span><span class="o">-</span><span class="n">oil</span><span class="o">-</span><span class="n">part4</span><span class="o">/*</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>
<span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">lab</span><span class="o">-</span><span class="n">app</span><span class="o">/</span>
</code></pre></div>

<p>You'll need to update line #1 of requestServiceHelper.mjs in the scripts folder. Get the invoke URL from your API Gateway:</p>
<ul>
<li>Click Stages on the left bar</li>
<li>Under stage details find Invoke URL and copy that address</li>
<li>Paste that as the value of the baseUrl on the first line of requestServiceHelper.mjs</li>
</ul>
<p>Once you've updated the files, you should visit your app and make sure it displays the three current service requests at the bottom of the request service page.</p>
	</article>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/highlight/highlight.pack.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.js"></script>
    <script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/contrib/auto-render.min.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/smartquotes/smartquotes.min.js"></script>
    <script>

        /* Startup scripts for katex rendering */
    	renderMathInElement(document.body,
		{
			delimiters: [
				{left: "$$", right: "$$", display: true},
				{left: "$", right: "$", display: false},
			]
    	});

        /* Highlighting code */
    	hljs.initHighlightingOnLoad();
    	var elements = document.querySelectorAll('.language-text')
		for (var i = 0; i < elements.length; i++) {
  			elements[i].classList.add('hljs');
		}

        /* TOC support */
        var hideContents = function(e){
            console.log(e.target);
            if(e.target.id === 'modal-screen' || e.target.nodeName.toLowerCase() === 'i') {
                e.preventDefault();
                document.querySelector('#contents-wrapper').classList.remove('active');
                document.querySelector('#modal-screen').classList.remove('active');
            }
        }

        var showContents = function(e){
            e.preventDefault();
            document.querySelector('#contents-wrapper').classList.add('active');
            document.querySelector('#modal-screen').classList.add('active');
        }

        document.querySelector("#hide-contents").addEventListener('click', hideContents);
        document.querySelector("#modal-screen").addEventListener('click', hideContents);
        document.querySelector("#show-contents").addEventListener('click', showContents);
    	
    </script>
</body>
</html>