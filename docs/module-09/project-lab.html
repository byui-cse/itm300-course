<!DOCTYPE html>
<html>
<head>
	<title>Module 09: Project 9 Lab - Vehicle History Update</title>
    <style>
        @font-face {
            font-family: 'icomoon';
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot');
            src: url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.eot#iefix-8k8p81') format('embedded-opentype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.ttf') format('truetype'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.woff') format('woff'), url('https://byui-cse.github.io/itm300-course/shared/fonts/byui/icomoon.svg#icomoon') format('svg');
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">        

    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/reset.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/fonts/fontawesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.css">
    <link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/lib/highlight/styles/monokai-sublime.min.css">
	<link rel="stylesheet" type="text/css" href="https://byui-cse.github.io/itm300-course/shared/cse450.css?v1.5.7">
    <meta charset="utf-8">

</head>
<body class="index-page">
     <div id="modal-screen">
        <div id="contents-wrapper">
            <div class="toc">
<ul>
<li><a href="#product-objective">Product Objective</a></li>
<li><a href="#create-new-lambda-function">Create new lambda function</a></li>
<li><a href="#update-the-api-gateway">Update the API Gateway</a></li>
<li><a href="#update-code">Update code</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#code-review">Code Review</a></li>
<li><a href="#reflection-questions">Reflection Questions</a></li>
</ul>
</div>

            <a href="#" id="hide-contents" title="Close Table of Contents"><i class="far fa-window-close"></i></a>
        </div>
    </div>
	<header>
        <span class="icon-byui-logo"></span>
        <div id="titles">
            <h1>ITM 300 - Cloud Foundations</h1>
            <h2>Module 09: Project 9 Lab - Vehicle History Update</h2>
            <nav><a href="https://byui-cse.github.io/itm300-course"><i class="fas fa-home"></i></a><a href="https://byui-cse.github.io/itm300-course/modules/">Modules</a><a href="https://byui-cse.github.io/itm300-course/test-prep/">Test Prep</a></nav>
        </div>
        <a href="#" id="show-contents" title="Show Table of Contents"><i class="far fa-list-alt"></i></a>
    </header>
	<article>
		<p><img alt="Quick Oil Change and Repair" src="https://byui-cse.github.io/itm300-course/shared/img/quick-logo-vehicle-history.jpg" /></p>
<h2 id="product-objective">Product Objective</h2>
<p>Technicians have quested to be able to see past repair history for the vehicles. We'll be adding this new feature to the app.</p>
<h2 id="create-new-lambda-function">Create new lambda function</h2>
<p>Create a new lambda function</p>
<ul>
<li><strong>Function Name:</strong> adminVehicleHistory</li>
<li>Open Change Default Execution Role</li>
<li>Use an existing role</li>
<li><strong>Existing Role:</strong> LabRole</li>
<li>Create Function</li>
</ul>
<p>Update the index.mjs code</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="p">{</span> <span class="n">getVehicleHistory</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;./adminVehicleHistory.mjs&#39;</span><span class="p">;</span>

<span class="n">const</span> <span class="n">commonHeaders</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">:</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">:</span> <span class="s1">&#39;OPTIONS,POST,GET,PUT&#39;</span>
<span class="p">};</span>

<span class="n">export</span> <span class="n">const</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>

    <span class="n">const</span> <span class="n">httpMethod</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">httpMethod</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">path</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">path</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">resource</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">pathParameters</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pathParameters</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">queryParameters</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">queryStringParameters</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">body</span> <span class="err">?</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="p">:</span> <span class="n">null</span><span class="p">;</span>    
    <span class="n">let</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="n">switch</span> <span class="p">(</span><span class="n">httpMethod</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>  
        <span class="k">if</span><span class="p">(</span><span class="n">pathParameters</span> <span class="o">&amp;&amp;</span> <span class="n">pathParameters</span><span class="o">.</span><span class="n">id</span><span class="p">){</span>
          <span class="n">jsonArray</span> <span class="o">=</span> <span class="k">await</span> <span class="n">getVehicleHistory</span><span class="p">(</span><span class="n">pathParameters</span><span class="o">.</span><span class="n">id</span><span class="p">);</span>
          <span class="o">//</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="p">{</span><span class="n">message</span><span class="p">:</span><span class="s2">&quot;Yep&quot;</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="n">jsonArray</span> <span class="o">=</span> <span class="p">{</span><span class="n">message</span><span class="p">:</span><span class="s2">&quot;No Plate Provided&quot;</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="n">body</span><span class="p">:</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">jsonArray</span><span class="p">),</span>
      <span class="n">headers</span><span class="p">:</span> <span class="n">commonHeaders</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">statusCode</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
      <span class="n">body</span><span class="p">:</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">({</span> <span class="n">message</span><span class="p">:</span> <span class="s1">&#39;Internal Server Error&#39;</span> <span class="p">}),</span>
      <span class="n">headers</span><span class="p">:</span> <span class="n">commonHeaders</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>Create a new file <em>adminVehicleHistory.mjs</em> and update it with this code</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="p">{</span> <span class="n">SNSClient</span><span class="p">,</span> <span class="n">PublishCommand</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/client-sns&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">ES</span> <span class="n">Modules</span> <span class="kn">import</span>
<span class="nn">import</span> <span class="p">{</span> <span class="n">DynamoDBClient</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/client-dynamodb&quot;</span><span class="p">;</span>
<span class="kn">import</span> <span class="p">{</span>
  <span class="n">DynamoDBDocumentClient</span><span class="p">,</span>
  <span class="n">QueryCommand</span><span class="p">,</span>
  <span class="n">PutCommand</span><span class="p">,</span>
  <span class="n">GetCommand</span><span class="p">,</span>
  <span class="n">DeleteCommand</span><span class="p">,</span>
  <span class="n">UpdateCommand</span><span class="p">,</span>
<span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@aws-sdk/lib-dynamodb&quot;</span><span class="p">;</span>

<span class="n">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DynamoDBClient</span><span class="p">({});</span>

<span class="n">const</span> <span class="n">mydynamodb</span> <span class="o">=</span> <span class="n">DynamoDBDocumentClient</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

<span class="n">const</span> <span class="n">tableName</span> <span class="o">=</span> <span class="s2">&quot;VehicleServices&quot;</span><span class="p">;</span>    

<span class="n">export</span> <span class="n">const</span> <span class="n">getVehicleHistory</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="n">license_plate</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">const</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TableName</span><span class="p">:</span> <span class="n">tableName</span><span class="p">,</span>
            <span class="n">KeyConditionExpression</span><span class="p">:</span> <span class="s2">&quot;#license_plate = :license_plate&quot;</span><span class="p">,</span>
            <span class="n">ExpressionAttributeNames</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;#license_plate&quot;</span><span class="p">:</span> <span class="s2">&quot;license_plate&quot;</span>
            <span class="p">},</span>
            <span class="n">ExpressionAttributeValues</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;:license_plate&quot;</span><span class="p">:</span> <span class="n">license_plate</span>
            <span class="p">}</span>
        <span class="p">};</span>      
        <span class="n">const</span> <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mydynamodb</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">QueryCommand</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">Items</span><span class="p">;</span> <span class="o">//</span> <span class="n">Return</span> <span class="n">JSON</span> <span class="n">string</span> <span class="n">of</span> <span class="n">items</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error fetching DynamoDB service requests:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
        <span class="n">throw</span> <span class="n">error</span><span class="p">;</span> <span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">throw</span> <span class="n">the</span> <span class="n">error</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span> <span class="n">further</span> <span class="n">up</span> <span class="n">the</span> <span class="n">call</span> <span class="n">stack</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Click Deploy</p>
<h2 id="update-the-api-gateway">Update the API Gateway</h2>
<p>Search for API Gateway</p>
<p>We'll create two resources. The first is the main area for vehicle-history</p>
<ul>
<li>Click on /admin-service-request</li>
<li>Click Create resource</li>
<li><strong>Resource Name</strong>: vehicle-history</li>
<li>Turn on CORS</li>
<li>Create resource</li>
</ul>
<p>Now we'll create the second that will respond for specific histories based on license plate number.</p>
<ul>
<li>Click on /vehicle-history</li>
<li>Click Create resource</li>
<li><strong>Resource Name</strong>: {id}</li>
<li>Turn on CORS</li>
<li>Create Resource</li>
</ul>
<p>You should have /vehicle-history/{id} selected. We'll now create the GET method.</p>
<ul>
<li>Click Create method</li>
<li><strong>Method type:</strong> GET</li>
<li>Lambda Function</li>
<li>Lambda proxy integration</li>
<li><strong>lambda function:</strong> adminVehicleHistory</li>
<li>Open Method Request Settings</li>
<li><strong>Authorization:</strong> AdminServiceRequestAuthorizer</li>
</ul>
<p>DEPLOY (this may take a couple of minutes)</p>
<h2 id="update-code">Update code</h2>
<p>Connect to your Vehicle App EC2 Instance</p>
<p>Download the newest website app:</p>
<div class="codehilite"><pre><span></span><code>wget https://github.com/byui-cse/itm300-course/raw/main/source/module-09/rebuildapp.sh
</code></pre></div>

<div class="codehilite"><pre><span></span><code>chmod +x ./rebuildapp.sh
</code></pre></div>

<p>Next run the script which will download the newest files. </p>
<div class="codehilite"><pre><span></span><code>sudo bash ./rebuildapp.sh
</code></pre></div>

<p>Now when you log in to your app you should have an area that will allow you to search for vehicle histories based on license plate number. Also, the license plate numbers in the current service requests will also be linked to quickly go to the vehicle histories.</p>
<h2 id="summary">Summary</h2>
<p>In this lab, students added a new feature to an existing AWS-based application, enabling technicians to view the repair history of vehicles. This involved creating a new AWS Lambda function, setting up appropriate resources in the API Gateway, and updating the application code. The lab walked through creating and configuring the Lambda function, updating the API Gateway to handle new endpoints, and deploying the changes to the application.</p>
<h2 id="code-review">Code Review</h2>
<p>Take a minute and review the lambda function code that you added. Identify what is happening with the code. If you don't understand a line of code, use an AI resource like chatGPT to dig into what the code is doing by asking questions until you understand the code.</p>
<p>Review the code found in the /var/www/html folder. Specifically look at the following code:</p>
<ul>
<li>vehicle-history.html</li>
<li>scripts/vehicle-requests.js</li>
<li>scripts/vehicleHistoryHelper.js</li>
</ul>
<p>How does this code interact with the lambda functions that were created in the lab? Identify any code that you do not understand and research it using generative AI.</p>
<h2 id="reflection-questions">Reflection Questions</h2>
<ul>
<li><strong>Technical Understanding:</strong> What are the advantages of using AWS Lambda for serverless computing? How does the integration of API Gateway with Lambda functions enhance the capabilities of web applications?</li>
<li><strong>Application and Deployment:</strong> What challenges might arise when deploying new features to an existing application in a production environment? How do the changes in the API Gateway configuration affect the application's functionality and security?</li>
<li><strong>Database Interactions:</strong> Why is DynamoDB a suitable choice for storing vehicle service records? Why might you choose a NoSQL database over a relational database? What considerations should be made when querying a DynamoDB table for performance optimization?</li>
<li><strong>Security and Access Management:</strong> Why is it important to specify an authorization method, like AdminServiceRequestAuthorizer, for API Gateway methods?</li>
<li><strong>Practical Experience:</strong> What was the most challenging part of setting up and testing the new Lambda function and why? How would you improve the process of updating and deploying new features in a cloud-based application?</li>
<li><strong>Rapid Development and Deployment of New Features</strong> How does the use of AWS services like Lambda and API Gateway facilitate the rapid development and deployment of new features, and what strategies can be employed to ensure that these rapid changes do not introduce bugs or security vulnerabilities into the production environment? What should we consider when thinking about the balance between speed and quality in software development, particularly in the context of using serverless and managed services.</li>
</ul>
	</article>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/highlight/highlight.pack.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/katex.min.js"></script>
    <script src="https://byui-cse.github.io/itm300-course/shared/lib/katex/contrib/auto-render.min.js"></script>
	<script src="https://byui-cse.github.io/itm300-course/shared/lib/smartquotes/smartquotes.min.js"></script>
    <script>

        /* Startup scripts for katex rendering */
    	renderMathInElement(document.body,
		{
			delimiters: [
				{left: "$$", right: "$$", display: true},
				{left: "$", right: "$", display: false},
			]
    	});

        /* Highlighting code */
    	hljs.initHighlightingOnLoad();
    	var elements = document.querySelectorAll('.language-text')
		for (var i = 0; i < elements.length; i++) {
  			elements[i].classList.add('hljs');
		}

        /* TOC support */
        var hideContents = function(e){
            console.log(e.target);
            if(e.target.id === 'modal-screen' || e.target.nodeName.toLowerCase() === 'i') {
                e.preventDefault();
                document.querySelector('#contents-wrapper').classList.remove('active');
                document.querySelector('#modal-screen').classList.remove('active');
            }
        }

        var showContents = function(e){
            e.preventDefault();
            document.querySelector('#contents-wrapper').classList.add('active');
            document.querySelector('#modal-screen').classList.add('active');
        }

        document.querySelector("#hide-contents").addEventListener('click', hideContents);
        document.querySelector("#modal-screen").addEventListener('click', hideContents);
        document.querySelector("#show-contents").addEventListener('click', showContents);
    	
    </script>
</body>
</html>